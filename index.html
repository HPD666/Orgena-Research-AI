<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Orgena AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0e0f13; --panel: #161822; --text: #e7e9f3; --muted: #a7adc8;
      --accent: #6ea8fe; --accent2: #8ce89a; --danger: #ff6b6b; --border: #262a3a;
      --link: #9ecbff;
    }
    * { box-sizing: border-box }
    html, body { height: 100%; background: var(--bg); color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    body { margin: 0; display: grid; grid-template-rows: auto 1fr auto; }
    header { padding: 14px 16px; border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, #141722 0%, #10121a 100%); display: flex; align-items: center; gap: 12px; }
    header h1 { margin: 0; font-size: 18px; letter-spacing: 0.3px }
    header .status { margin-left: auto; font-size: 12px; color: var(--muted) }
    header .badge { display:inline-block; padding:2px 8px; border:1px solid var(--border);
      border-radius: 999px; font-size: 12px; color: var(--muted) }
    .container { display: grid; grid-template-columns: 320px 1fr; min-height: 0 }
    aside { border-right: 1px solid var(--border); background: var(--panel); overflow: auto; padding: 12px; }
    main { display: grid; grid-template-rows: 1fr auto; min-height: 0 }
    .chat { overflow: auto; padding: 18px; }
    .msg { display: grid; grid-template-columns: 40px 1fr; gap: 10px;
      padding: 10px 12px; border-radius: 12px; margin-bottom: 8px; }
    .msg.user { background: #1c2030 }
    .msg.bot { background: #151a27; border: 1px solid var(--border) }
    .avatar { width: 40px; height: 40px; border-radius: 8px; background: #0c101a;
      display:flex; align-items:center; justify-content:center; font-weight: 700; color: var(--accent); border:1px solid var(--border); }
    .content { white-space: pre-wrap; line-height: 1.6 }
    .content a { color: var(--link); text-decoration: none }
    .content a:hover { text-decoration: underline }
    .content code { background: #0f1320; padding: 2px 5px; border-radius: 6px; border:1px solid #1f2440 }
    .tools { padding: 12px; border-top: 1px solid var(--border); background: #131622; }
    .row { display:flex; gap: 8px; }
    textarea { flex: 1; resize: none; padding: 12px; border-radius: 12px; border: 1px solid var(--border);
      background: #101423; color: var(--text); min-height: 70px; outline: none; }
    button, select, input[type="text"], input[type="number"], input[type="checkbox"] {
      background: #0f1422; color: var(--text); border: 1px solid var(--border); padding: 10px 12px; border-radius: 10px;
    }
    button { cursor: pointer }
    button.primary { background: #132244; border-color: #1d376e }
    button[disabled] { opacity: .6; cursor: not-allowed }
    .settings { display: grid; gap: 12px; }
    .settings h2 { font-size: 14px; margin: 8px 0; color: var(--muted) }
    .kv { display: grid; grid-template-columns: 1fr; gap: 8px }
    .kv label { font-size: 12px; color: var(--muted) }
    .pill { display:flex; gap:6px; align-items:center; flex-wrap: wrap }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .small { font-size: 12px; color: var(--muted) }
    .danger { color: var(--danger) }
    .bar { display:flex; gap:8px; align-items:center; justify-content: space-between; padding: 8px 0 }
    .right { margin-left: auto }
    .footer { padding: 8px 16px; font-size: 12px; color: var(--muted); border-top: 1px solid var(--border); background:#10131c }
    .chip { display:inline-block; padding:2px 8px; border:1px dashed var(--border); border-radius: 999px;
      font-size: 12px; color: var(--muted); margin-right: 6px }
    .hl { color: var(--accent2); }
    .fade { opacity: .85 }
    .skeleton { background: linear-gradient(90deg, #151a27 25%, #1b2132 37%, #151a27 63%); background-size: 400% 100%; animation: shimmer 1.4s infinite; height: 12px; border-radius: 6px; margin: 6px 0; }
    @keyframes shimmer { 0% { background-position: 200% 0 } 100% { background-position: -200% 0 } }
    .typing { display:inline-block; border-right: 2px solid var(--accent); animation: caret 1s steps(1) infinite; }
    @keyframes caret { 50% { border-right-color: transparent } }
  </style>
</head>
<body>
  <header>
    <div class="avatar">.</div>
    <h1>Orgena</h1>
    <span class="badge">Web-based</span>
    <span class="status" id="status"> Researcher AI</span>
  </header>

  <div class="container">
    <aside>
      <div class="settings">
        <h2>Response Settings</h2>

        <div class="kv">
          <label>Format</label>
          <div class="pill">
            <label class="small"><input type="checkbox" id="markdown" checked> Markdown</label>
            <label class="small"><input type="checkbox" id="richTables" checked> Rich tables</label>
            <label class="small"><input type="checkbox" id="codeBlocks" checked> Code blocks</label>
            <label class="small"><input type="checkbox" id="showSources" checked> Source links</label>
          </div>
        </div>

        <div class="kv">
          <div class="pill">
            <label class="small">Speed (ms/char) <input type="number" id="typeSpeed" min="1" max="50" step="1" value="10"></label>
            <label class="small"><input type="checkbox" id="skeletonLoad" checked> Loading stripes</label>
          </div>
        </div>

        <h2>Keyless Sources</h2>
        <div class="pill">
          <label class="small"><input type="checkbox" id="useDDG" checked> DuckDuckGo IA</label>
          <label class="small"><input type="checkbox" id="useWiki" checked> Wikipedia search/summary</label>
          <label class="small"><input type="checkbox" id="useWikidata" checked> Wikidata</label>
          <label class="small"><input type="checkbox" id="useWeather"> Open-Meteo (weather)</label>
          <label class="small"><input type="checkbox" id="useWikiLinks" checked> Wikipedia external links</label>
        </div>

        <div class="kv">
          <label>Advanced</label>
          <div class="pill">
            <label class="small"><input type="checkbox" id="useJina" checked> Web content fetch (r.jina.ai)</label>
          </div>
        </div>

        <h2>Chat</h2>
        <div class="bar">
          <button id="newChat">New chat</button>
          <button id="exportChat">Export</button>
          <button id="clearChat" class="danger">Clear</button>
        </div>

        <div class="kv">
          <label class="small">Note</label>
          <div class="small fade">On CORS-restricted sources, text is automatically read via “r.jina.ai”.</div>
        </div>
      </div>
    </aside>

    <main>
      <div id="chat" class="chat"></div>
      <div class="tools">
        <div class="row">
          <textarea id="input" placeholder="Ask anything: technical, comparison, report, table, weather, wiki, real web…" rows="3"></textarea>
          <button id="send" class="primary">Send</button>
        </div>
        <div class="bar">
          <div class="chip">Orgena active</div>
          <div class="chip">Real web compilation</div>
          <span class="small right">World-focused content possible</span>
        </div>
      </div>
    </main>
  </div>

  <div class="footer">
    <span>Ask anything… but don’t ask how I am. I can’t answer that :)</span>
  </div>

  <script>
    const el = {
      chat: document.getElementById('chat'),
      input: document.getElementById('input'),
      send: document.getElementById('send'),
      status: document.getElementById('status'),
      markdown: document.getElementById('markdown'),
      richTables: document.getElementById('richTables'),
      codeBlocks: document.getElementById('codeBlocks'),
      typeSpeed: document.getElementById('typeSpeed'),
      skeletonLoad: document.getElementById('skeletonLoad'),
      useDDG: document.getElementById('useDDG'),
      useWiki: document.getElementById('useWiki'),
      useWikidata: document.getElementById('useWikidata'),
      useWeather: document.getElementById('useWeather'),
      useWikiLinks: document.getElementById('useWikiLinks'),
      useJina: document.getElementById('useJina'),
      showSources: document.getElementById('showSources'),
      newChat: document.getElementById('newChat'),
      exportChat: document.getElementById('exportChat'),
      clearChat: document.getElementById('clearChat'),
    };
    const botName = 'Orgena';
    let messages = [];

    // Minimal Markdown renderer (lead-in bold for list items)
    function renderMarkdown(md) {
      let s = md;
      s = s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      s = s.replace(/^###### (.*)$/gm, '<h6>$1</h6>');
      s = s.replace(/^##### (.*)$/gm, '<h5>$1</h5>');
      s = s.replace(/^#### (.*)$/gm, '<h4>$1</h4>');
      s = s.replace(/^### (.*)$/gm, '<h3>$1</h3>');
      s = s.replace(/^## (.*)$/gm, '<h2>$1</h2>');
      s = s.replace(/^# (.*)$/gm, '<h1>$1</h1>');
      s = s.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      s = s.replace(/`([^`]+)`/g, '<code>$1</code>');
      s = s.replace(/^- (.*)$/gm, '<li><strong>$1:</strong></li>');
      s = s.replace(/(\n<li>.*<\/li>)+/g, m => `<ul>${m}</ul>`);
      s = s.replace(/\[(.*?)\]`\((.*?)\)`/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
      s = s.replace(/\n/g, '<br/>');
      return s;
    }

    function addMsg(role, content, animate=true) {
      const wrap = document.createElement('div');
      wrap.className = 'msg ' + (role === 'user' ? 'user' : 'bot');
      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.textContent = role === 'user' ? 'S' : 'O';
      const body = document.createElement('div');
      body.className = 'content';
      wrap.appendChild(avatar);
      wrap.appendChild(body);
      el.chat.appendChild(wrap);
      scrollBottom();

      if (!animate || role === 'user') {
        body.innerHTML = el.markdown.checked ? renderMarkdown(content) : content;
      } else {
        typeWithAnimation(body, content, Number(el.typeSpeed.value || 12));
      }
    }

    function typeWithAnimation(node, text, speed=12) {
      const md = el.markdown.checked ? renderMarkdown(text) : text;
      const temp = document.createElement('div'); temp.innerHTML = md;
      const plain = temp.textContent || text;
      node.innerHTML = '';
      const span = document.createElement('span'); span.className = 'typing'; node.appendChild(span);
      let i = 0;
      const timer = setInterval(() => {
        span.textContent = plain.slice(0, i);
        i++;
        if (i > plain.length) { clearInterval(timer); node.innerHTML = md; }
        node.scrollIntoView({ behavior:'smooth', block:'end' });
      }, speed);
    }

    function showSkeletonLines(parent, count=5) {
      const box = document.createElement('div');
      for (let i=0;i<count;i++) {
        const sk = document.createElement('div'); sk.className = 'skeleton';
        sk.style.width = (60 + Math.random()*35) + '%';
        box.appendChild(sk);
      }
      parent.appendChild(box);
      return () => box.remove();
    }

    function push(role, content) {
      messages.push({ role, content });
      addMsg(role, content, role==='assistant');
      persistChat();
    }

    function scrollBottom() { el.chat.scrollTop = el.chat.scrollHeight; }
    function persistChat() { try { localStorage.setItem('sf_chat', JSON.stringify(messages)); } catch(e){} }
    function loadChat() {
      try {
        const raw = localStorage.getItem('sf_chat'); if (!raw) return;
        messages = JSON.parse(raw) || [];
        el.chat.innerHTML = '';
        messages.forEach(m => addMsg(m.role, m.content, false));
      } catch(e){}
    }

    // Keyless Sources
    async function ddgInstant(q) {
      const url = `https://api.duckduckgo.com/?q=${encodeURIComponent(q)}&format=json&no_html=1&skip_disambig=1`;
      const r = await fetch(url); if (!r.ok) throw new Error('DDG IA error: '+r.status);
      const j = await r.json();
      return {
        source: 'DuckDuckGo',
        abstract: j.AbstractText || '',
        heading: j.Heading || '',
        url: j.AbstractURL || '',
        related: (j.RelatedTopics || []).slice(0,5).map(x => {
          if (typeof x === 'object' && x.Text) return { text: x.Text, url: x.FirstURL };
          return null;
        }).filter(Boolean)
      };
    }

    async function wikipediaSearch(q) {
      const url = `https://tr.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(q)}&format=json&origin=*`;
      const r = await fetch(url); if (!r.ok) throw new Error('Wikipedia search error: '+r.status);
      const j = await r.json();
      const hit = j.query?.search?.[0];
      if (!hit) return null;
      const title = hit.title;
      return { title, pageid: hit.pageid };
    }

    async function wikipediaSummary(title) {
      const langOrder = ['tr','en'];
      for (const lang of langOrder) {
        const url = `https://${lang}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;
        const r = await fetch(url);
        if (r.ok) {
          const j = await r.json();
          if (j.extract) {
            return { source:'Wikipedia '+lang, title:j.title, summary:j.extract, url:j.content_urls?.desktop?.page || j.content_urls?.mobile?.page || '' };
          }
        }
      }
      return null;
    }

    async function wikipediaExternalLinks(title) {
      const url = `https://tr.wikipedia.org/w/api.php?action=parse&page=${encodeURIComponent(title)}&prop=externallinks&format=json&origin=*`;
      const r = await fetch(url); if (!r.ok) throw new Error('Wikipedia externallinks error: '+r.status);
      const j = await r.json();
      const links = j.parse?.externallinks || [];
      return links.filter(u => /^https?:\/\//.test(u)).slice(0, 6);
    }

    async function wikidataSearch(q) {
      const url = `https://www.wikidata.org/w/api.php?action=wbsearchentities&search=${encodeURIComponent(q)}&language=tr&format=json&origin=*`;
      const r = await fetch(url); if (!r.ok) throw new Error('Wikidata error: '+r.status);
      const j = await r.json();
      const item = (j.search||[])[0];
      if (!item) return null;
      return { source:'Wikidata', id:item.id, label:item.label, desc:item.description, url:`https://www.wikidata.org/wiki/${item.id}` };
    }

    async function openMeteo(lat, lon) {
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,precipitation&current_weather=true`;
      const r = await fetch(url); if (!r.ok) throw new Error('Open-Meteo error: '+r.status);
      const j = await r.json();
      return { source:'Open-Meteo', data:j };
    }

    // Web content fetch (CORS-safe text reader)
    async function readWeb(url) {
      const proxy = `https://r.jina.ai/http://` + url.replace(/^https?:\/\//,'');
      const r = await fetch(proxy, { headers: { 'Accept': 'text/plain' } });
      if (!r.ok) throw new Error('Web read error: '+r.status);
      const txt = await r.text();
      return { source:'Web', url, text: txt.slice(0, 20000) };
    }

    // Orchestration
    async function orchestrate(q) {
      const lower = q.toLowerCase();
      const sources = [];
      const links = [];
      const isWeather = /(hava|weather|meteoroloji|yağmur|sıcaklık)/.test(lower) && /(istanbul|çekmeköy|koordinat|lat|lon|maltepe)/.test(lower);

      if (el.useDDG.checked) { try { sources.push(await ddgInstant(q)); } catch(e){} }

      let wikiTitle = null;
      if (el.useWiki.checked) {
        try {
          const hit = await wikipediaSearch(q);
          if (hit && hit.title) {
            wikiTitle = hit.title;
            const sum = await wikipediaSummary(hit.title);
            if (sum) {
              sources.push(sum);
              if (sum.url) links.push(sum.url);
            }
          }
        } catch(e){}
      }

      if (el.useWikidata.checked) {
        try {
          const wd = await wikidataSearch(q);
          if (wd) {
            sources.push(wd);
            if (wd.url) links.push(wd.url);
          }
        } catch(e){}
      }

      if (el.useWeather.checked && isWeather) {
        const m = q.match(/(-?\d+(\.\d+)?),\s*(-?\d+(\.\d+)?)/);
        const lat = m ? Number(m[1]) : 41.015;
        const lon = m ? Number(m[3]) : 29.0;
        try { sources.push(await openMeteo(lat, lon)); } catch(e){}
      }

      let webTexts = [];
      if (el.useWikiLinks.checked && wikiTitle) {
        try {
          const ext = await wikipediaExternalLinks(wikiTitle);
          const top = ext.slice(0, 4);
          for (const u of top) {
            if (!el.useJina.checked) break;
            try {
              const w = await readWeb(u);
              webTexts.push(w);
            } catch(e){}
          }
        } catch(e){}
      }

      return synthesize(q, sources, links, webTexts);
    }

    function synthesize(q, sources, links, webTexts) {
      const srcLinks = [];
      const facts = [];
      let summary = '';
      let meta = [];

      for (const s of sources) {
        if (!s) continue;
        if (s.source?.includes('DuckDuckGo')) {
          if (s.abstract && !summary) summary = s.abstract;
          if (s.url) srcLinks.push({ label: s.heading || 'DuckDuckGo', url: s.url });
          (s.related||[]).forEach(rt => srcLinks.push({ label: rt.text.slice(0,40)+'…', url: rt.url }));
          meta.push('DDG IA');
        } else if (String(s.source).startsWith('Wikipedia')) {
          summary = summary || s.summary;
          if (s.url) srcLinks.push({ label: s.title, url: s.url });
          meta.push(s.source);
        } else if (s.source === 'Wikidata') {
          facts.push(`Wikidata: ${s.label} — ${s.desc || 'no description'}`);
          if (s.url) srcLinks.push({ label: s.label || 'Wikidata', url: s.url });
          meta.push('Wikidata');
        } else if (s.source === 'Open-Meteo') {
          const cw = s.data?.current_weather || {};
          facts.push(`Weather: temperature ${cw.temperature}°C, wind ${cw.windspeed} m/s`);
          meta.push('Open-Meteo');
        }
      }

      const webSummaries = webTexts.map(w => summarizeWeb(w.text));
      webSummaries.forEach((ws, i) => {
        facts.push(`Web${i+1}: ${ws.key} — ${truncate(ws.summary, 300)}`);
        srcLinks.push({ label: ws.key, url: webTexts[i].url });
      });

      const table = el.richTables.checked ? buildTable(facts) : '';
      const linksMd = el.showSources.checked ? buildLinks(srcLinks) : '';

      const response =
`## Query
**Request:** ${q}

### Short Summary
${summary || 'No direct summary from sources; a synthesized response is provided based on collected data.'}

### Compiled Information
${facts.length ? facts.map(f => `- **Info:** ${f}`).join('\n') : '- **Info:** Topic too specific or sources limited; proceeding with guidance steps.'}

${table ? '\n### Table\n' + table : ''}

### Actionable Steps
- **Clarify:** Your topic and expected output (table/code/report).
- **Verify:** Check links individually and review text portions.
- **Refine:** Use more specific keywords (place, date, technical term).

### Sources
${linksMd || 'Public APIs and web text were used; some sites may be CORS-restricted.'}

### Brief Conclusion
- **Path:** Use the above findings as a starting point and follow up with a more focused query.`;

      return response;
    }

    function buildTable(items) {
      if (!items || items.length === 0) return '';
      const rows = items.slice(0,8).map((x,i) => `| ${i+1} | ${x} |`).join('\n');
      return [
        '| # | Compiled Information |',
        '|---|---|',
        rows
      ].join('\n');
    }

    function buildLinks(links) {
      if (!links || links.length === 0) return '';
      return links.slice(0,10).map(l => `- **Source:** [${l.label}](${l.url})`).join('\n');
    }

    function summarizeWeb(text) {
      const lines = (text || '').split('\n').map(s => s.trim()).filter(Boolean);
      const key = (lines[0] || 'Web content').slice(0, 80);
      const body = lines.slice(1).join(' ');
      const summary = body.split(/\s+/).slice(0,120).join(' ');
      return { key, summary };
    }

    function truncate(s, n) { if (!s) return ''; return s.length <= n ? s : s.slice(0, n) + '…'; }

    async function handleSend() {
      const text = el.input.value.trim();
      if (!text) return;
      el.input.value = '';
      push('user', text);

      let removeSk = null;
      if (el.skeletonLoad.checked) {
        const last = document.createElement('div');
        last.className = 'msg bot';
        const avatar = document.createElement('div'); avatar.className = 'avatar'; avatar.textContent = 'O';
        const body = document.createElement('div'); body.className = 'content';
        last.appendChild(avatar); last.appendChild(body);
        el.chat.appendChild(last);
        removeSk = showSkeletonLines(body, 6);
        scrollBottom();
      }

      try {
        const answer = await orchestrate(text);
        if (removeSk) removeSk();
        push('assistant', answer);
      } catch (e) {
        if (removeSk) removeSk();
        push('assistant', `## Connection/Access Error\n- **Status:** ${e.message}\n- **Suggestion:** Source may be restricted (CORS). Rephrase the query or try different keywords.`);
      }
    }

    el.send.addEventListener('click', handleSend);
    el.input.addEventListener('keydown', (ev) => { if (ev.key === 'Enter' && !ev.shiftKey) { ev.preventDefault(); handleSend(); } });
    el.clearChat.addEventListener('click', () => { messages = []; el.chat.innerHTML = ''; persistChat(); });
    el.newChat.addEventListener('click', () => {
      messages = []; el.chat.innerHTML = '';
      push('assistant', `Hello! I am “${botName}”. You can ask me anything. What would you like to learn?`);
    });
    el.exportChat.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify({ bot: botName, messages }, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `chat-${Date.now()}.json`; a.click();
      URL.revokeObjectURL(url);
    });

    loadChat();
    if (messages.length === 0) {
      push('assistant', `Hello Istanbul! I am “${botName}”. I collect data from the real web and synthesize it. Example: “London rainwater infrastructure—sources + table”, “Italy earthquake regulation comparison—linked summary”.`);
    }
  </script>

  <script>
function addMsg(role, content, animate=true) {
  const wrap = document.createElement('div');
  wrap.className = 'msg ' + (role === 'user' ? 'user' : 'bot');
  const avatar = document.createElement('div');
  avatar.className = 'avatar';
  avatar.textContent = role === 'user' ? 'S' : '.';
  const body = document.createElement('div');
  body.className = 'content';

  // Add timestamp
  const timestamp = document.createElement('div');
  timestamp.className = 'small fade';
  const now = new Date();
  timestamp.textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  body.appendChild(timestamp);

  wrap.appendChild(avatar);
  wrap.appendChild(body);
  el.chat.appendChild(wrap);
  scrollBottom();

  if...
</script>

</body>
</html>
